\hypertarget{_sliding_window_8h_source}{
\section{MVCCommonLib/SlidingWindow.h}
}


\begin{footnotesize}\begin{alltt}
00001 \textcolor{comment}{/************************************************************************}
00002 \textcolor{comment}{*}
00003 \textcolor{comment}{* MVC Codec}
00004 \textcolor{comment}{* }
00005 \textcolor{comment}{* History}
00006 \textcolor{comment}{* 2009-04-09            Weidong Hu              Tsinghua University             C
      reate}
00007 \textcolor{comment}{* }
00008 \textcolor{comment}{************************************************************************/}
00009 
00010 \textcolor{preprocessor}{#ifndef \_SLIDING\_WINDOW\_H\_}
00011 \textcolor{preprocessor}{}\textcolor{preprocessor}{#define \_SLIDING\_WINDOW\_H\_}
\hypertarget{_sliding_window_8h_source_l00012}{}\hyperlink{_sliding_window_8h_aac0db9a0280340fa820b89366c85d392}{00012} \textcolor{preprocessor}{}\textcolor{preprocessor}{#define MASTER\_CODE}
00013 \textcolor{preprocessor}{}\textcolor{preprocessor}{#ifdef SLAVE\_CODE}
00014 \textcolor{preprocessor}{}\textcolor{preprocessor}{#error "Can not include master code in slave program"}
00015 \textcolor{preprocessor}{}\textcolor{preprocessor}{#endif // SLAVE\_CODE}
00016 \textcolor{preprocessor}{}
00017 \textcolor{preprocessor}{#include "\hyperlink{_picture_info_8h}{PictureInfo.h}"}
00018 \textcolor{preprocessor}{#include "\hyperlink{_slice_param_8h}{Codec/SliceParam.h}"}
00019 
\hypertarget{_sliding_window_8h_source_l00020}{}\hyperlink{structtag_sliding_item_a3d1f87274664505c5fb9fe06d3cd16d3}{00020} \textcolor{keyword}{typedef} \textcolor{keyword}{struct }\hyperlink{structtag_sliding_item}{tagSlidingItem} \{
\hypertarget{_sliding_window_8h_source_l00021}{}\hyperlink{structtag_sliding_item_a56c9f0817a904f6257d5de4e28c28724}{00021}         \hyperlink{struct_coding_pict_info}{CodingPictInfo} \hyperlink{structtag_sliding_item_a3d1f87274664505c5fb9fe06d3cd16d3}{pictInfo};
00022         \hyperlink{struct_slice_parameters}{SliceParameters} \hyperlink{structtag_sliding_item_a56c9f0817a904f6257d5de4e28c28724}{sp};
00023 \} \hyperlink{structtag_sliding_item}{SlidingItem};
00024 
\hypertarget{_sliding_window_8h_source_l00025}{}\hyperlink{class_sliding_window}{00025} \textcolor{keyword}{class }\hyperlink{class_sliding_window}{SlidingWindow}
00026 \{
00027 \textcolor{keyword}{private}:
00028         \textcolor{keywordtype}{int} \_width;
00029         \textcolor{keywordtype}{int} \_height;
00030         \textcolor{keywordtype}{int} \_viewCount;
00031         \textcolor{keywordtype}{int} \_refWidth;
00032 
00033         \textcolor{keywordtype}{int} \_slidingFrameCount;
00034         \textcolor{keywordtype}{int} \_slidingWindowSizeM1;
00035         \hyperlink{structtag_sliding_item}{SlidingItem} *\_slidingWindow;
00036         \textcolor{keywordtype}{int} \_firstUnfinished;
00037         \textcolor{keywordtype}{int} \_firstAvail;
00038         \textcolor{keywordtype}{int} \_keep;
00039         \textcolor{keywordtype}{int} \_lastUnsaved;
00040         \textcolor{keywordtype}{bool} \_dataFinished;
00041 
00042         \textcolor{keywordtype}{void} AllocMem(\hyperlink{struct_coding_pict_info}{CodingPictInfo} &info)
00043         \{
00044                 info.\hyperlink{struct_coding_pict_info_aa6352dc53234c55d1a0c252c5b8d6141}{Size_Height} = \_height;
00045                 info.\hyperlink{struct_coding_pict_info_afeeb373571d44e64d473524e6127f3f7}{Size_Width} = \_width;
00046                 info.\hyperlink{struct_coding_pict_info_a62aee8cc8c9cac725d4f44a19ddc8c2b}{lumaStart} = (\hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t}*)\hyperlink{_arch_8h_a82f8f71a4da739209ebbe575faa842e9}{getMemAligned}(\_width * \_height);
00047                 info.\hyperlink{struct_coding_pict_info_a103a3180ba57db0bd984a53f0668b70b}{chromaUStart} = (\hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t}*)\hyperlink{_arch_8h_a82f8f71a4da739209ebbe575faa842e9}{getMemAligned}(\_width * \_height / 4)
      ;
00048                 info.\hyperlink{struct_coding_pict_info_a7be3395b2a1e7f4b384421c2490dcfdc}{chromaVStart} = (\hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t}*)\hyperlink{_arch_8h_a82f8f71a4da739209ebbe575faa842e9}{getMemAligned}(\_width * \_height / 4)
      ;
00049                 info.\hyperlink{struct_coding_pict_info_aa49520dd613a44185d6a41af8992d66c}{refVec} = (\hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t} *)\hyperlink{_arch_8h_a82f8f71a4da739209ebbe575faa842e9}{getMemAligned}(\_width/4 * \_height/4 * \textcolor{keyword}{siz
      eof}(\hyperlink{structref_vector}{refVector}) * 2);
00050                 info.\hyperlink{struct_coding_pict_info_af53de7a35b8796df845ddee01d70fc5b}{resultStream} = (\hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t}*)\hyperlink{_arch_8h_a82f8f71a4da739209ebbe575faa842e9}{getMemAligned}(50000);
00051                 info.\hyperlink{struct_coding_pict_info_a37155b7c53db0a4a94d314bdc3c95104}{resultSize} = (\hyperlink{_types_8h_a115ba3a1b24a8702355c5dbd61ce01e0}{int32_t}*)\hyperlink{_arch_8h_a82f8f71a4da739209ebbe575faa842e9}{getMemAligned}(4);
00052                 info.\hyperlink{struct_coding_pict_info_a41498e5ba764405481005e6569d7f728}{pictStatus} = \hyperlink{_picture_info_8h_ac2f16d038f94c6c57ed8648c6cfe3bb7}{PICT_STATUS_WAIT};
00053                 \textcolor{comment}{//info.refVec = (uint8\_t*)getMemAligned(\_width * \_height / 8);}
00054         \}
00055 
00056         \textcolor{keywordtype}{int} GetFirstUnmarked(\textcolor{keywordtype}{int} mark, \textcolor{keywordtype}{int} first, \textcolor{keywordtype}{int} last)
00057         \{
00058                 \textcolor{keywordtype}{int} offset = (first * \_viewCount) & \_slidingWindowSizeM1;
00059                 \textcolor{keywordflow}{while} (first < last)
00060                 \{
00061                         \textcolor{keywordtype}{bool} ok = \textcolor{keyword}{true};
00062                         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < \_viewCount; ++i)
00063                         \{
00064                                 \textcolor{keywordflow}{if} (!(\_slidingWindow[offset].pictInfo.pictStatus&
      mark))
00065                                 \{
00066                                         ok = \textcolor{keyword}{false};
00067                                         \textcolor{keywordflow}{break};
00068                                 \}
00069                                 offset = (offset + 1) & \_slidingWindowSizeM1;
00070                         \}
00071                         \textcolor{keywordflow}{if} (!ok)
00072                                 \textcolor{keywordflow}{break};
00073                         ++first;
00074                 \}
00075                 \textcolor{keywordflow}{return} first;
00076         \}
00077 
00078 \textcolor{keyword}{public}:
00079 
\hypertarget{_sliding_window_8h_source_l00080}{}\hyperlink{class_sliding_window_a5fde76017cc202055cf3ae3011258106}{00080}         \hyperlink{class_sliding_window_a5fde76017cc202055cf3ae3011258106}{SlidingWindow}()
00081                 : \_slidingFrameCount(0), \_width(0), \_height(0), \_viewCount(0), \_r
      efWidth(0), \_dataFinished(false)
00082         \{
00083                 \_firstUnfinished = 0;
00084                 \_firstAvail = 0;
00085                 \_keep = 0;
00086                 \_lastUnsaved = 0;
00087         \}
00088 
\hypertarget{_sliding_window_8h_source_l00089}{}\hyperlink{class_sliding_window_aa833d1b81d72234b0e37364295820e96}{00089}         \hyperlink{class_sliding_window_a5fde76017cc202055cf3ae3011258106}{SlidingWindow}(\textcolor{keywordtype}{int} width, \textcolor{keywordtype}{int} height, \textcolor{keywordtype}{int} viewCount, \textcolor{keywordtype}{int} refWidth, \textcolor{keywordtype}{int} sli
      dingFrameCount)
00090                 : \_slidingFrameCount(0), \_width(0), \_height(0), \_viewCount(0), \_r
      efWidth(0), \_dataFinished(false)
00091         \{
00092                 \hyperlink{class_sliding_window_ac71c1ed41e1b33a1ef3623c881e6d9d7}{Init}(width, height, viewCount, refWidth, slidingFrameCount);
00093                 \_firstUnfinished = 0;
00094                 \_firstAvail = 0;
00095                 \_keep = 0;
00096                 \_lastUnsaved = 0;
00097         \}
00098 
\hypertarget{_sliding_window_8h_source_l00099}{}\hyperlink{class_sliding_window_ac71c1ed41e1b33a1ef3623c881e6d9d7}{00099}         \textcolor{keywordtype}{void} \hyperlink{class_sliding_window_ac71c1ed41e1b33a1ef3623c881e6d9d7}{Init}(\textcolor{keywordtype}{int} width, \textcolor{keywordtype}{int} height, \textcolor{keywordtype}{int} viewCount, \textcolor{keywordtype}{int} refWidth, \textcolor{keywordtype}{int} sliding
      FrameCount)
00100         \{
00101                 refWidth = refWidth * 2;
00102                 slidingFrameCount = refWidth * 2;
00103                 \_slidingFrameCount = slidingFrameCount;
00104                 \_width = width;
00105                 \_height = height;
00106                 \_viewCount = viewCount;
00107                 \_refWidth = refWidth;
00108                 \textcolor{keywordtype}{int} slidingWindowSize = \_viewCount * slidingFrameCount;
00109                 ++slidingWindowSize;
00110                 \textcolor{keywordflow}{while} (slidingWindowSize & (slidingWindowSize - 1))
00111                         slidingWindowSize = (slidingWindowSize | (slidingWindowSi
      ze - 1)) + 1;
00112                 printf(\textcolor{stringliteral}{"slidingWindowSize = %d\(\backslash\)n"}, slidingWindowSize);
00113                 \_slidingWindow = \textcolor{keyword}{new} \hyperlink{structtag_sliding_item}{SlidingItem}[slidingWindowSize];
00114                 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < slidingWindowSize; ++i)
00115                         AllocMem(\_slidingWindow[i].pictInfo);
00116                 \_slidingWindowSizeM1 = slidingWindowSize - 1;
00117         \}
00118 
\hypertarget{_sliding_window_8h_source_l00119}{}\hyperlink{class_sliding_window_a2128091c76b407cd0e244759ba5a2846}{00119}         \textcolor{keywordtype}{int} \hyperlink{class_sliding_window_a2128091c76b407cd0e244759ba5a2846}{GetFirstAvail}()\textcolor{keyword}{ const}
00120 \textcolor{keyword}{        }\{
00121                 \textcolor{keywordflow}{return} \_firstAvail;
00122         \}
00123 
\hypertarget{_sliding_window_8h_source_l00124}{}\hyperlink{class_sliding_window_a7bce9e53d3618b89f47684ec1432848d}{00124}         \textcolor{keywordtype}{void} \hyperlink{class_sliding_window_a7bce9e53d3618b89f47684ec1432848d}{IncreaseAvail}()
00125         \{
00126                 \_firstAvail = GetFirstUnmarked(\hyperlink{_picture_info_8h_aecbf7bf3158e75ca4906202b17b8f9ef}{PICT_STATUS_AVAIL}, \_firstAvail, 
      \hyperlink{class_sliding_window_a3df64e20282ce10a45c4c3f3011e536d}{GetUnsaved}() + \_slidingFrameCount);
00127         \}
00128 
\hypertarget{_sliding_window_8h_source_l00129}{}\hyperlink{class_sliding_window_a3df64e20282ce10a45c4c3f3011e536d}{00129}         \textcolor{keywordtype}{int} \hyperlink{class_sliding_window_a3df64e20282ce10a45c4c3f3011e536d}{GetUnsaved}()
00130         \{
00131                 \hyperlink{class_sliding_window_aea027ce6f77dcee09d1aafb31d5732c5}{IncreaseSaved}();
00132                 \textcolor{keywordflow}{return} \_lastUnsaved;
00133         \}
00134 
\hypertarget{_sliding_window_8h_source_l00135}{}\hyperlink{class_sliding_window_aea027ce6f77dcee09d1aafb31d5732c5}{00135}         \textcolor{keywordtype}{void} \hyperlink{class_sliding_window_aea027ce6f77dcee09d1aafb31d5732c5}{IncreaseSaved}()
00136         \{
00137                 \textcolor{keywordtype}{int} lastUnsaved = GetFirstUnmarked(\hyperlink{_picture_info_8h_a81f2be9d3984eb16fa6f3b7daf46466f}{PICT_STATUS_SAVED}, \_lastUnsave
      d, \hyperlink{class_sliding_window_a0aafbf41ff2b7bb6c32fb60075bfeb22}{GetKeep}());
00138                 \textcolor{keywordtype}{int} offset = (\_lastUnsaved * \_viewCount) & \_slidingWindowSizeM1;
00139                 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = \_lastUnsaved; i < lastUnsaved; ++i)
00140                 \{
00141                         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < \_viewCount; ++j)
00142                         \{
00143                                 \_slidingWindow[offset].\hyperlink{structtag_sliding_item_a3d1f87274664505c5fb9fe06d3cd16d3}{pictInfo}.\hyperlink{struct_coding_pict_info_a41498e5ba764405481005e6569d7f728}{pictStatus} = 
      \hyperlink{_picture_info_8h_ac2f16d038f94c6c57ed8648c6cfe3bb7}{PICT_STATUS_WAIT};
00144                                 offset = (offset + 1) & \_slidingWindowSizeM1;
00145                         \}
00146                 \}
00147                 \_lastUnsaved = lastUnsaved;
00148         \}
00149 
\hypertarget{_sliding_window_8h_source_l00150}{}\hyperlink{class_sliding_window_a0aafbf41ff2b7bb6c32fb60075bfeb22}{00150}         \textcolor{keywordtype}{int} \hyperlink{class_sliding_window_a0aafbf41ff2b7bb6c32fb60075bfeb22}{GetKeep}()
00151         \{
00152                 \textcolor{keywordflow}{if} (\_dataFinished && (\_firstUnfinished == \_firstAvail))
00153                         \_keep = \_firstUnfinished;
00154                 \textcolor{keywordflow}{return} \_keep;
00155         \}
00156 
\hypertarget{_sliding_window_8h_source_l00157}{}\hyperlink{class_sliding_window_a9b7a7426f6a495da2770e0743d4c97d7}{00157}         \textcolor{keywordtype}{void} \hyperlink{class_sliding_window_a9b7a7426f6a495da2770e0743d4c97d7}{IncreaseKeep}()
00158         \{
00159                 ++\_keep;
00160         \}
00161 
\hypertarget{_sliding_window_8h_source_l00162}{}\hyperlink{class_sliding_window_a3be69abc76bff5b71ab96dadcced9f65}{00162}         \textcolor{keywordtype}{int} \hyperlink{class_sliding_window_a3be69abc76bff5b71ab96dadcced9f65}{GetFirstUnfinished}()
00163         \{
00164                 \textcolor{keywordflow}{return} \_firstUnfinished;
00165         \}
00166 
\hypertarget{_sliding_window_8h_source_l00167}{}\hyperlink{class_sliding_window_a8f303bc211297021f20e09dced119207}{00167}         \textcolor{keywordtype}{void} \hyperlink{class_sliding_window_a8f303bc211297021f20e09dced119207}{IncreaseFinish}()
00168         \{
00169                 \_firstUnfinished = GetFirstUnmarked(\hyperlink{_picture_info_8h_a170d5962358e97425e08d5646653494b}{PICT_STATUS_FINISHED}, \_firstU
      nfinished, \_firstAvail);
00170                 \textcolor{keywordflow}{if} (\_dataFinished && (\_firstUnfinished == \_firstAvail))
00171                         \_keep = \_firstUnfinished;
00172                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (\_firstUnfinished - \_keep > \_refWidth)
00173                         \_keep = \_firstUnfinished - \_refWidth;
00174         \}
00175 
\hypertarget{_sliding_window_8h_source_l00176}{}\hyperlink{class_sliding_window_a012dbfd5902b37d5ce3d37a115d9a96e}{00176}         \textcolor{keywordtype}{void} \hyperlink{class_sliding_window_a012dbfd5902b37d5ce3d37a115d9a96e}{InitPictInfo}(\textcolor{keywordtype}{int} timeId, \textcolor{keywordtype}{int} viewId)
00177         \{
00178                 \hyperlink{struct_coding_pict_info}{CodingPictInfo} &info = *\hyperlink{class_sliding_window_ac50874323a2aaa4ef76fab47f80c9f92}{GetCodingPictInfo}(timeId, viewId);
00179                 info.\hyperlink{struct_coding_pict_info_ad85dae4751165ea3cbb8f7b8c6e61dc3}{timeId} = timeId;
00180                 info.\hyperlink{struct_coding_pict_info_a987595091bfba91b3166b04bca988697}{viewId} = viewId;
00181                 info.\hyperlink{struct_coding_pict_info_a41498e5ba764405481005e6569d7f728}{pictStatus} = \hyperlink{_picture_info_8h_ac2f16d038f94c6c57ed8648c6cfe3bb7}{PICT_STATUS_WAIT};
00182         \}
00183 
\hypertarget{_sliding_window_8h_source_l00184}{}\hyperlink{class_sliding_window_ac50874323a2aaa4ef76fab47f80c9f92}{00184}         \hyperlink{struct_coding_pict_info}{CodingPictInfo} *\hyperlink{class_sliding_window_ac50874323a2aaa4ef76fab47f80c9f92}{GetCodingPictInfo}(\textcolor{keywordtype}{int} timeId, \textcolor{keywordtype}{int} viewId)
00185         \{
00186                 \textcolor{keywordflow}{if} (timeId - \hyperlink{class_sliding_window_a3df64e20282ce10a45c4c3f3011e536d}{GetUnsaved}() >= \_slidingFrameCount)
00187                         \textcolor{keywordflow}{return} 0;
00188                 \textcolor{keywordtype}{int} offset = (timeId * \_viewCount + viewId) & \_slidingWindowSizeM
      1;
00189                 \textcolor{keywordflow}{return} &(\_slidingWindow[offset].\hyperlink{structtag_sliding_item_a3d1f87274664505c5fb9fe06d3cd16d3}{pictInfo});
00190         \}
00191 
\hypertarget{_sliding_window_8h_source_l00192}{}\hyperlink{class_sliding_window_a020d2c25f1bda31337f91bf9b1a809d1}{00192}         \hyperlink{struct_slice_parameters}{SliceParameters} *\hyperlink{class_sliding_window_a020d2c25f1bda31337f91bf9b1a809d1}{GetSliceParameters}(\textcolor{keywordtype}{int} timeId, \textcolor{keywordtype}{int} viewId)
00193         \{
00194                 \textcolor{keywordflow}{if} (timeId - \hyperlink{class_sliding_window_a3df64e20282ce10a45c4c3f3011e536d}{GetUnsaved}() >= \_slidingFrameCount)
00195                         \textcolor{keywordflow}{return} 0;
00196                 \textcolor{keywordtype}{int} offset = (timeId * \_viewCount + viewId) & \_slidingWindowSizeM
      1;
00197                 \textcolor{keywordflow}{return} &(\_slidingWindow[offset].\hyperlink{structtag_sliding_item_a56c9f0817a904f6257d5de4e28c28724}{sp});
00198         \}
00199 
\hypertarget{_sliding_window_8h_source_l00200}{}\hyperlink{class_sliding_window_afd67521d283b68f9fbc769ee9c0ba4b4}{00200}         \textcolor{keywordtype}{bool} \hyperlink{class_sliding_window_afd67521d283b68f9fbc769ee9c0ba4b4}{IsDataFinished}()\textcolor{keyword}{ const }
00201 \textcolor{keyword}{        }\{
00202                 \textcolor{keywordflow}{return} \_dataFinished;
00203         \}
00204 
\hypertarget{_sliding_window_8h_source_l00205}{}\hyperlink{class_sliding_window_ac2fd5605777fc2f4fdff84282a8467f8}{00205}         \textcolor{keywordtype}{void} \hyperlink{class_sliding_window_ac2fd5605777fc2f4fdff84282a8467f8}{SetDataFinished}()
00206         \{
00207                 \_dataFinished = \textcolor{keyword}{true};
00208         \}
00209 \};
00210 
00211 \textcolor{preprocessor}{#endif //\_SLIDING\_WINDOW\_H\_}
00212 \textcolor{preprocessor}{}
\end{alltt}\end{footnotesize}
