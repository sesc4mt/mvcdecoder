
%%% Local Variables: 
%%% mode: latex
%%% TeX-master: t
%%% End: 

\chapter{部分源代码}
\label{cha:sourcecode}

\begin{lstlisting}[caption = {idct8x8（C++实现）}, label = lst:idct8x8c++]
void idct8x8(int16 *piCoeff )
{
	Int aai[8][8];
	//Int n;

	for(int n = 0; n < 8; ++n )
	{
		TCoeff* pi = piCoeff + (n << 3);
		Int     ai1[8];
		Int     ai2[8];

		ai1[0] = pi[0] + pi[4];
		ai1[2] = pi[0] - pi[4];

		ai1[4] = (pi[2]>>1) -  pi[6];
		ai1[6] =  pi[2]     + (pi[6]>>1);

		ai1[1] = pi[5] - pi[3] - pi[7] - (pi[7]>>1);
		ai1[3] = pi[1] + pi[7] - pi[3] - (pi[3]>>1);;
		ai1[5] = pi[7] - pi[1] + pi[5] + (pi[5]>>1);
		ai1[7] = pi[3] + pi[5] + pi[1] + (pi[1]>>1);

		ai2[0] = ai1[0] + ai1[6];
		ai2[6] = ai1[0] - ai1[6];

		ai2[2] = ai1[2] + ai1[4];
		ai2[4] = ai1[2] - ai1[4];

		ai2[1] = ai1[1] + (ai1[7]>>2);
		ai2[7] = ai1[7] - (ai1[1]>>2);

		ai2[3] =  ai1[3]     + (ai1[5]>>2);
		ai2[5] = (ai1[3]>>2) -  ai1[5];

		aai[n][0] = ai2[0] + ai2[7];
		aai[n][1] = ai2[2] + ai2[5];
		aai[n][2] = ai2[4] + ai2[3];
		aai[n][3] = ai2[6] + ai2[1];
		aai[n][4] = ai2[6] - ai2[1];
		aai[n][5] = ai2[4] - ai2[3];
		aai[n][6] = ai2[2] - ai2[5];
		aai[n][7] = ai2[0] - ai2[7];
	}

	for(int n = 0; n < 8; ++n, ++piCoeff )
	{
		Int ai1[8];
		Int ai2[8];

		ai1[0] =  aai[0][n] +  aai[4][n];
		ai1[1] =  aai[5][n] -  aai[3][n] - aai[7][n] - (aai[7][n]>>1);
		ai1[2] =  aai[0][n] -  aai[4][n];
		ai1[3] =  aai[1][n] +  aai[7][n] - aai[3][n] - (aai[3][n]>>1);
		ai1[4] = (aai[2][n]>>1) -  aai[6][n];
		ai1[5] =  aai[7][n] -  aai[1][n] + aai[5][n] + (aai[5][n]>>1);
		ai1[6] =  aai[2][n] + (aai[6][n]>>1);
		ai1[7] =  aai[3][n] +  aai[5][n] + aai[1][n] + (aai[1][n]>>1);

		ai2[2] = ai1[2] + ai1[4];
		ai2[4] = ai1[2] - ai1[4];

		ai2[0] = ai1[0] + ai1[6];
		ai2[6] = ai1[0] - ai1[6];

		ai2[1] = ai1[1] + (ai1[7]>>2);
		ai2[7] = ai1[7] - (ai1[1]>>2);

		ai2[3] =  ai1[3]     + (ai1[5]>>2);
		ai2[5] = (ai1[3]>>2) -  ai1[5];

		piCoeff[0] = (ai2[0] + ai2[7] + 32) >> 6;
		piCoeff[8] = (ai2[2] + ai2[5] + 32) >> 6;
		piCoeff[16] = (ai2[4] + ai2[3] + 32) >> 6;
		piCoeff[24] = (ai2[6] + ai2[1] + 32) >> 6;
		piCoeff[32] = (ai2[6] - ai2[1] + 32) >> 6;
		piCoeff[40] = (ai2[4] - ai2[3] + 32) >> 6;
		piCoeff[48] = (ai2[2] - ai2[5] + 32) >> 6;
		piCoeff[56] = (ai2[0] - ai2[7] + 32) >> 6;
	}
}
\end{lstlisting}


\begin{lstlisting}[caption = {idct8x8（SSE2实现）}, label = lst:idct8x8sse2, language = {[x86masm]Assembler}]
;************************************************************************
;* SSE2-optimized H.264 iDCT
;************************************************************************
;* Copyright (C) 2003-2008 x264 project
;*
;* Authors: Laurent Aimar <fenrir@via.ecp.fr>
;*          Loren Merritt <lorenm@u.washington.edu>
;*          Holger Lubitz <hal@duncan.ol.sub.de>
;*          Min Chen <chenm001.163.com>
;*
;* This program is free software; you can redistribute it and/or modify
;* it under the terms of the GNU General Public License as published by
;* the Free Software Foundation; either version 2 of the License, or
;* (at your option) any later version.
;*
;* This program is distributed in the hope that it will be useful,
;* but WITHOUT ANY WARRANTY; without even the implied warranty of
;* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;* GNU General Public License for more details.
;*
;* You should have received a copy of the GNU General Public License
;* along with this program; if not, write to the Free Software
;* Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02111, USA.
;************************************************************************

%include "x86inc.asm"
%include "x86util.asm"

SECTION_RODATA
pw_32: times 8 dw 32

SECTION .text

INIT_XMM
cglobal x264_add8x4_idct_sse2, 3,3,8
    movq   m0, [r1+ 0]
    movq   m1, [r1+ 8]
    movq   m2, [r1+16]
    movq   m3, [r1+24]
    movhps m0, [r1+32]
    movhps m1, [r1+40]
    movhps m2, [r1+48]
    movhps m3, [r1+56]
    IDCT4_1D 0,1,2,3,4,5
    TRANSPOSE2x4x4W 0,1,2,3,4
    paddw m0, [pw_32 GLOBAL]
    IDCT4_1D 0,1,2,3,4,5
    pxor  m7, m7
    STORE_DIFF  m0, m4, m7, [r0]
    STORE_DIFF  m1, m4, m7, [r0+r2]
    lea   r0, [r0+r2*2]
    STORE_DIFF  m2, m4, m7, [r0]
    STORE_DIFF  m3, m4, m7, [r0+r2]
    RET
\end{lstlisting}