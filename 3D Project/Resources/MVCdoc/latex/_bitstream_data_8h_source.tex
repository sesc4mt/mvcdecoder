\hypertarget{_bitstream_data_8h_source}{
\section{MVCDecoder/BitstreamData.h}
}


\begin{footnotesize}\begin{alltt}
00001 \textcolor{comment}{/************************************************************************}
00002 \textcolor{comment}{ *}
00003 \textcolor{comment}{ * MVC Codec}
00004 \textcolor{comment}{ * }
00005 \textcolor{comment}{ * History}
00006 \textcolor{comment}{ * 2009-04-09           Weidong Hu              Tsinghua University             C
      reate}
00007 \textcolor{comment}{ * }
00008 \textcolor{comment}{ ************************************************************************/}
00009 
00010 \textcolor{preprocessor}{#ifndef \_BITSTREAM\_DATA\_H\_}
00011 \textcolor{preprocessor}{}\textcolor{preprocessor}{#define \_BITSTREAM\_DATA\_H\_}
00012 \textcolor{preprocessor}{}
00013 \textcolor{preprocessor}{#include "\hyperlink{_sliding_window_8h}{SlidingWindow.h}"}
00014 \textcolor{preprocessor}{#include "\hyperlink{_codec_info_8h}{CodecInfo.h}"}
00015 \textcolor{preprocessor}{#include "\hyperlink{_bitstream_8h}{Codec/Bitstream.h}"}
00016 \textcolor{preprocessor}{#include "\hyperlink{_in_stream_8h}{Stream/InStream.h}"}
00017 \textcolor{preprocessor}{#include "\hyperlink{_consts4_standard_8h}{Codec/Consts4Standard.h}"}
00018 
\hypertarget{_bitstream_data_8h_source_l00019}{}\hyperlink{class_bitstream_data}{00019} \textcolor{keyword}{class }\hyperlink{class_bitstream_data}{BitstreamData}
00020 \{
00021 \textcolor{keyword}{private}:
00022         \hyperlink{class_sliding_window}{SlidingWindow} *\_slidingWindow;
00023         FILE *\_file;
00024         MVCMasterThreadHandle thread;
00025         \hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t} *fileBuf;
00026         \textcolor{keywordtype}{int} bufPos;
00027         \textcolor{keywordtype}{int} bufLen;
00028         \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{int} FILE\_BUF\_SIZE = 65536;
00029 
00030         \textcolor{keyword}{static} \textcolor{keywordtype}{int} BitstreamReader(\textcolor{keywordtype}{void} *param)
00031         \{
00032                 \hyperlink{class_bitstream_data}{BitstreamData} *\textcolor{keyword}{self} = (\hyperlink{class_bitstream_data}{BitstreamData} *)param;
00033                 \textcolor{keyword}{self}->ProcessData();
\hypertarget{_bitstream_data_8h_source_l00034}{}\hyperlink{class_bitstream_data_a0a84eec74369ca5b7754250b683aaaaa}{00034}                 \textcolor{keywordflow}{return} 0;
00035         \}
00036 \textcolor{keyword}{public}:
00037         \hyperlink{class_bitstream_data_a0a84eec74369ca5b7754250b683aaaaa}{BitstreamData}(\hyperlink{class_sliding_window}{SlidingWindow} *slidingWindow, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *fileName) : \_slid
      ingWindow(slidingWindow), bufPos(0), bufLen(0)
00038         \{
00039                 fileBuf = \textcolor{keyword}{new} \hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t}[FILE\_BUF\_SIZE];
00040                 \_file = fopen(fileName, \textcolor{stringliteral}{"rb"});
00041                 \hyperlink{_debug_8h_a101586fab2b90a8adffe50a3550e235d}{ASSERT}(\_file);
\hypertarget{_bitstream_data_8h_source_l00042}{}\hyperlink{class_bitstream_data_a508c273c706e9ab418307d688f743b74}{00042}                 thread = MVCCreateMasterThread(BitstreamReader, \textcolor{keyword}{this});
00043         \}
00044 
00045         \hyperlink{class_bitstream_data_a508c273c706e9ab418307d688f743b74}{~BitstreamData}()
00046         \{
00047                 MVCWaitMasterThread(thread);
00048                 fclose(\_file);
\hypertarget{_bitstream_data_8h_source_l00049}{}\hyperlink{class_bitstream_data_a9475d45cccc6018ece6dec99caad1e58}{00049}                 \textcolor{keyword}{delete}[] fileBuf;
00050         \}
00051 
00052         \textcolor{keywordtype}{bool} \hyperlink{class_bitstream_data_a9475d45cccc6018ece6dec99caad1e58}{LoadNextStream}(\hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t} *stream, \textcolor{keywordtype}{int} &len)
00053         \{
00054                 len = 0;
00055                 \textcolor{keywordtype}{int} t0 = 0;
00056                 \textcolor{keywordtype}{bool} started = \textcolor{keyword}{false};
00057                 \textcolor{keywordflow}{while} (\textcolor{keyword}{true})
00058                 \{
00059                         \textcolor{keywordflow}{if} (bufPos >= bufLen)
00060                         \{
00061                                 \textcolor{keywordflow}{if} (bufPos>3)
00062                                 \{
00063                                         fileBuf[0] = fileBuf[bufPos-3];
00064                                         fileBuf[1] = fileBuf[bufPos-2];
00065                                         fileBuf[2] = fileBuf[bufPos-1];
00066                                 \}
00067                                 bufLen = fread(fileBuf+3, 1, FILE\_BUF\_SIZE-3, \_fi
      le) + 3;
00068                                 bufPos = 3;
00069                                 \textcolor{keywordflow}{if} (bufLen <= 3)
00070                                         \textcolor{keywordflow}{return} started;
00071                         \}
00072 
00073                         \textcolor{keywordflow}{if} (started && t0>=2 && (fileBuf[bufPos]==1))
00074                         \{
00075                                 bufPos -= 3;
00076                                 len -= t0;
00077                                 \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00078                         \}
00079                         \textcolor{keywordflow}{if} (started && !(t0>=2 && (fileBuf[bufPos]==3)))
00080                         \{
00081                                 stream[len++] = fileBuf[bufPos];
00082                         \}
00083                         \textcolor{keywordflow}{if} (t0>=3 && (fileBuf[bufPos]==1))
00084                         \{
00085                                 started = \textcolor{keyword}{true};
00086                         \}
00087                         \textcolor{keywordflow}{if} (!fileBuf[bufPos])
00088                                 ++t0;
00089                         \textcolor{keywordflow}{else}
00090                                 t0 = 0;
00091                         ++bufPos;
\hypertarget{_bitstream_data_8h_source_l00092}{}\hyperlink{class_bitstream_data_a3832355fc8add0ba405771f0276bddf5}{00092}                 \}
00093         \}
00094 
00095         \textcolor{keywordtype}{void} \hyperlink{class_bitstream_data_a3832355fc8add0ba405771f0276bddf5}{ProcessData}()
00096         \{
00097                 \hyperlink{struct_sequence_parameters_set}{SequenceParametersSet} &sps = \hyperlink{class_codec_info_ad439fd8062a03d868dfe9c9b615b747e}{CodecInfo::GetInstance}().\hyperlink{class_codec_info_aee785011cec77ff3c0c646b498fe1e7d}{sps};
00098                 \hyperlink{struct_picture_parameters_set}{PictureParametersSet} &pps = \hyperlink{class_codec_info_ad439fd8062a03d868dfe9c9b615b747e}{CodecInfo::GetInstance}().\hyperlink{class_codec_info_abaa8d84a7d4045129ee64d91eaac4481}{pps};
00099                 \hyperlink{struct_slice_parameters}{SliceParameters} sp;
00100 
00101 
00102                 sp.\hyperlink{struct_slice_parameters_ae570f1ba10b1e091c7519264534a7143}{viewId} = 0;
00103                 sps.\hyperlink{struct_sequence_parameters_set_af32c7819f630856ccd99aaf78e8f656c}{viewCount} = 1;
00104                 sps.\hyperlink{struct_sequence_parameters_set_a082e13208bc0afd9377676e156e750b4}{viewCodingOrder}.\hyperlink{class_array_list_acb53d54675318c94332d0ec8b6819eb3}{clear}();
00105                 sps.\hyperlink{struct_sequence_parameters_set_a082e13208bc0afd9377676e156e750b4}{viewCodingOrder}.\hyperlink{class_array_list_a7b5376678a9b5af0e0ed913fbe04b902}{push_back}(0);
00106                 sps.\hyperlink{struct_sequence_parameters_set_ae9b6a7d85da9fec255cca59c3d750ecd}{anchorRefsList0}.\hyperlink{class_array_list_acb53d54675318c94332d0ec8b6819eb3}{clear}();
00107                 \hyperlink{class_array_list}{ArrayList<int>} tmp;
00108                 sps.\hyperlink{struct_sequence_parameters_set_ae9b6a7d85da9fec255cca59c3d750ecd}{anchorRefsList0}.\hyperlink{class_array_list_a7b5376678a9b5af0e0ed913fbe04b902}{push_back}(tmp);
00109                 sps.\hyperlink{struct_sequence_parameters_set_a7b865f89c34428785081c3c4acadc965}{anchorRefsList1} = sps.\hyperlink{struct_sequence_parameters_set_ae9b6a7d85da9fec255cca59c3d750ecd}{anchorRefsList0};
00110                 sps.\hyperlink{struct_sequence_parameters_set_ab9b078b23e746ef60f7697896b963b93}{nonAnchorRefsList0} = sps.\hyperlink{struct_sequence_parameters_set_ae9b6a7d85da9fec255cca59c3d750ecd}{anchorRefsList0};
00111                 sps.\hyperlink{struct_sequence_parameters_set_a68b7ffb23b151c53312798f7ab79a67a}{nonAnchorRefsList1} = sps.\hyperlink{struct_sequence_parameters_set_ae9b6a7d85da9fec255cca59c3d750ecd}{anchorRefsList0};
00112                 \hyperlink{class_array_list}{ArrayList<int>} *ref\_frames = 0;
00113 
00114                 \hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t} *buf = \textcolor{keyword}{new} \hyperlink{_types_8h_a363e4d606232036a6b89060813c45489}{uint8_t}[100000];
00115                 \textcolor{keywordtype}{int} len;
00116                 \textcolor{keywordflow}{while} (\hyperlink{class_bitstream_data_a9475d45cccc6018ece6dec99caad1e58}{LoadNextStream}(buf, len))
00117                 \{
00118                         \hyperlink{class_in_stream}{InStream} is(buf, len);
00119                         \textcolor{keywordtype}{int} nalType = is.\hyperlink{class_in_stream_a95ef1b146ee1d6ab6152001fc7719478}{GetNalType}();
00120                         \textcolor{keywordflow}{switch} (nalType)
00121                         \{
00122                         \textcolor{keywordflow}{case} \hyperlink{_consts4_standard_8h_a0ae628337fb17a2b11855dd3524f3d04a87cac3a362213e69d6c5b959471f6f98}{NAL_UNIT_SPS}:
00123                                 is.\hyperlink{class_in_stream_abaa60d112267ece8de9f303623abd79d}{ReadSequenceParameterSet}(sps);
00124                                 \textcolor{keywordflow}{break};
00125                         \textcolor{keywordflow}{case} \hyperlink{_consts4_standard_8h_a0ae628337fb17a2b11855dd3524f3d04ac483bd065332f7337e31c959e7034e6f}{NAL_UNIT_SUBSET_SPS}:
00126                                 is.\hyperlink{class_in_stream_abb8e8d2b7eef014e7b6285e130a19a0a}{ReadSubsetSequenceParameterSet}(sps);
00127                                 \textcolor{keywordflow}{break};
00128                         \textcolor{keywordflow}{case} \hyperlink{_consts4_standard_8h_a0ae628337fb17a2b11855dd3524f3d04a0a937a1dcddd0ed49b7bbcc120a0a800}{NAL_UNIT_PPS}:
00129                                 is.\hyperlink{class_in_stream_a0f4a6aeef628f4ec90e8ff9ea2e8b566}{ReadPictureParameterSet}(pps);
00130                                 \textcolor{keywordflow}{break};
00131                         \textcolor{keywordflow}{case} \hyperlink{_consts4_standard_8h_a0ae628337fb17a2b11855dd3524f3d04a8c5dfdeb9a126add31b57b718eb32b46}{NAL_UNIT_CODED_SLICE_PREFIX}:
00132                                 is.\hyperlink{class_in_stream_ab40abe55d480a2dc42e484a8a7eb53a4}{ReadSlicePrefix}(sp, sps);
00133                                 \textcolor{keywordflow}{break};
00134                         \textcolor{keywordflow}{case} \hyperlink{_consts4_standard_8h_a0ae628337fb17a2b11855dd3524f3d04a59e9c5af2da46fe7a2d51fa43ab26127}{NAL_UNIT_CODED_SLICE}:
00135                         \textcolor{keywordflow}{case} \hyperlink{_consts4_standard_8h_a0ae628337fb17a2b11855dd3524f3d04aa641b2e28c7c244e45e28f99dfc63a54}{NAL_UNIT_CODED_SLICE_IDR}:
00136                         \textcolor{keywordflow}{case} \hyperlink{_consts4_standard_8h_a0ae628337fb17a2b11855dd3524f3d04a693f7e481367a7aad4420eb441703e8b}{NAL_UNIT_CODED_SLICE_SCALABLE}:
00137                                 \{
00138                                         \textcolor{keywordflow}{if} (!ref\_frames)
00139                                         \{
00140                                                 \_slidingWindow->\hyperlink{class_sliding_window_ac71c1ed41e1b33a1ef3623c881e6d9d7}{Init}(sps.\hyperlink{struct_sequence_parameters_set_a72286e512a40a01670e2519b3971cee2}{width}, s
      ps.\hyperlink{struct_sequence_parameters_set_ab3b7bd818f9a0d1456d92496473a42eb}{height}, sps.\hyperlink{struct_sequence_parameters_set_af32c7819f630856ccd99aaf78e8f656c}{viewCount}, sps.\hyperlink{struct_sequence_parameters_set_a8404973d25f8601dd012299638361f03}{numRefFrames}, sps.\hyperlink{struct_sequence_parameters_set_a8404973d25f8601dd012299638361f03}{numRefFrames} * 
      \hyperlink{class_configure_a0a595a8bf2825d2238fa77b2ecff2c5a}{Configure::GOP_LIMIT} + 1);
00141                                                 ref\_frames = \textcolor{keyword}{new} \hyperlink{class_array_list}{ArrayList<int>}[s
      ps.\hyperlink{struct_sequence_parameters_set_af32c7819f630856ccd99aaf78e8f656c}{viewCount}]();
00142                                         \}
00143                                         \textcolor{keywordtype}{int} fu = \_slidingWindow->
      \hyperlink{class_sliding_window_a3be69abc76bff5b71ab96dadcced9f65}{GetFirstUnfinished}();
00144                                         sp.\hyperlink{struct_slice_parameters_a60f8fe21acd611ec6892e47a2c6029e3}{IDR} = \textcolor{keyword}{false};
00145                                         \textcolor{keywordtype}{int} ps = is.\hyperlink{class_in_stream_a6369ed63c0fad1007f16e3e885825aea}{ReadSliceHeader}(sp, ref\_frame
      s, *\_slidingWindow, fu);
00146                                         \hyperlink{struct_coding_pict_info}{CodingPictInfo} *cpi;
00147                                         \textcolor{keywordflow}{while} (!(cpi = \_slidingWindow->
      \hyperlink{class_sliding_window_ac50874323a2aaa4ef76fab47f80c9f92}{GetCodingPictInfo}(sp.\hyperlink{struct_slice_parameters_ad6a26fe2f228235e4f0c31c336cf5e12}{timeId}, sp.\hyperlink{struct_slice_parameters_ae570f1ba10b1e091c7519264534a7143}{viewId})))
00148                                                 Sleep(10);
00149                                         \textcolor{comment}{//printf("READ %d, %d\(\backslash\)n", sp.timeId, sp.v
      iewId);}
00150                                         *\_slidingWindow->\hyperlink{class_sliding_window_a020d2c25f1bda31337f91bf9b1a809d1}{GetSliceParameters}(sp.
      \hyperlink{struct_slice_parameters_ad6a26fe2f228235e4f0c31c336cf5e12}{timeId}, sp.\hyperlink{struct_slice_parameters_ae570f1ba10b1e091c7519264534a7143}{viewId}) = sp;
00151                                         memcpy(cpi->\hyperlink{struct_coding_pict_info_af53de7a35b8796df845ddee01d70fc5b}{resultStream}, buf + ps/32*4, 
      len-ps/32*4);
00152                                         cpi->\hyperlink{struct_coding_pict_info_a589da1ebbfa6493b63005412ce79dac6}{streamStart} = ps & 31;
00153                                         *cpi->\hyperlink{struct_coding_pict_info_a37155b7c53db0a4a94d314bdc3c95104}{resultSize} = len * 8 - ps;
00154                                         cpi->\hyperlink{struct_coding_pict_info_a41498e5ba764405481005e6569d7f728}{pictStatus} |= \hyperlink{_picture_info_8h_aecbf7bf3158e75ca4906202b17b8f9ef}{PICT_STATUS_AVAIL};
00155                                         \_slidingWindow->\hyperlink{class_sliding_window_a7bce9e53d3618b89f47684ec1432848d}{IncreaseAvail}();
00156                                         \textcolor{keywordflow}{break};
00157                                 \}
00158                         \textcolor{keywordflow}{default} : ;
00159                         \}
00160                 \}
00161                 \_slidingWindow->\hyperlink{class_sliding_window_ac2fd5605777fc2f4fdff84282a8467f8}{SetDataFinished}();
00162                 \textcolor{keyword}{delete}[] buf;
00163         \}
00164 \};
00165 
00166 \textcolor{preprocessor}{#endif //\_BITSTREAM\_DATA\_H\_}
\end{alltt}\end{footnotesize}
